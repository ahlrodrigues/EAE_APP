<!-- Versão final corrigida, preservando todas as funções -->

<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>Relatório de Notas</title>
<style>
body { font-family: Arial, sans-serif; background-color: #f5f5f5; margin: 0; padding: 0; }
.container { max-width: 960px; margin: 2rem auto; padding: 2rem; background: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
header { text-align: center; margin-bottom: 1rem; }
header img { max-width: 100px; margin-bottom: 1rem; }
header h1 { margin: 0; color: #333; }
table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
th, td { padding: 1rem; text-align: left; border-bottom: 1px solid #ddd; }
th { background-color: #0077cc; color: white; }
tr:hover { background-color: #f9f9f9; }
button { padding: 0.5rem 1rem; background-color: #0077cc; color: white; border: none; border-radius: 6px; cursor: pointer; }
button:hover { background-color: #005fa3; }
.acoes-multiplas { display: flex; justify-content: flex-end; gap: 1rem; margin-top: 1rem; }
footer { text-align: center; margin-top: 2rem; padding: 1rem; font-size: 0.85rem; color: #555; }
.filtro { margin-bottom: 1rem; display: flex; gap: 1rem; align-items: center; justify-content: flex-end; }
.filtro input[type="date"] { padding: 0.4rem 0.6rem; font-size: 1rem; }
.nota-cartao { border:1px solid #ccc; border-radius:8px; margin:1rem 0; padding:1rem; background:#f9f9f9; page-break-inside: avoid;}
.nota-campo { margin-bottom: 0.8rem;}

</style>
</head>
<body>
<div class="container">
<header>
<img src="../assets/trevo.png" alt="Logo Trevo" />
<h1>ESCOLA DE APRENDIZES DO EVANGELHO</h1>
</header>
<div class="filtro">
<label for="dataInicio">De:</label><input type="date" id="dataInicio" />
<label for="dataFim">Até:</label><input type="date" id="dataFim" />
</div>
<div class="acoes-multiplas">
<button id="btnVisualizarSelecionados">Ver Selecionadas</button>
<button id="btnExportarSelecionados">Exportar</button>
<button id="btnExcluirSelecionados">Excluir</button>
</div>
<table id="tabelaNotas">
<thead>
<tr>
<th><input type="checkbox" id="selecionarTodos" /></th>
<th>#</th>
<th>Data</th>
<th>Ações</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
<footer>Relatório local — Escola de Aprendizes do Evangelho — 2025</footer>

<script>
window.addEventListener("DOMContentLoaded", async () => {
const tabela = document.querySelector("#tabelaNotas tbody");
const chkTodos = document.getElementById("selecionarTodos");

let arquivos = [];
try {
  arquivos = await window.electronAPI.listarNotas();
  renderTabela(arquivos);
} catch (error) {
  console.error("Erro ao listar notas:", error);
  alert("Erro ao carregar as notas.");
}

function formatarData(data) {
  if (!data) return "";
  const partes = data.split("-");
  if (partes.length !== 3) return data;
  return `${partes[2]}-${partes[1]}-${partes[0]}`;
}

function corrigirDataTexto(texto) {
  return texto.replace(
    /Data:\s*(\d{4})-(\d{2})-(\d{2})/g,
    (match, ano, mes, dia) => `Data: ${dia}-${mes}-${ano}`
  );
}

const dataInicioInput = document.getElementById("dataInicio");
const dataFimInput = document.getElementById("dataFim");
function filtrarNotasPorData(lista) {
  const dataInicio = dataInicioInput.value ? new Date(dataInicioInput.value) : null;
  const dataFim = dataFimInput.value ? new Date(dataFimInput.value) : null;

  if (!dataInicio && !dataFim) return lista; // Sem filtro aplicado

  return lista.filter(nome => {
    const dataNome = nome.split("T")[0];
    const [ano, mes, dia] = dataNome.split("-");
    const dataNota = new Date(`${ano}-${mes}-${dia}`);

    if (dataInicio && dataNota < dataInicio) return false;
    if (dataFim && dataNota > dataFim) return false;

    return true;
  });
}

function renderTabela(lista) {
  tabela.innerHTML = "";

  // Aplica o filtro de datas antes de desenhar a tabela
  const listaFiltrada = filtrarNotasPorData(lista);

  listaFiltrada.forEach((nome, index) => {
    const tr = document.createElement("tr");

    const checkbox = document.createElement("input");
    checkbox.type = "checkbox";
    checkbox.className = "linha-selecao";
    checkbox.dataset.nome = nome;

    const tdCheckbox = document.createElement("td");
    tdCheckbox.appendChild(checkbox);

    const tdIndex = document.createElement("td");
    tdIndex.textContent = index + 1;

    const tdData = document.createElement("td");
    tdData.textContent = formatarData(nome.split("T")[0]);

    const tdAcao = document.createElement("td");
    const btnVer = document.createElement("button");
    btnVer.textContent = "Ver nota";
    btnVer.onclick = async () => {
      const conteudo = await window.electronAPI.lerNota(nome);
      const partes = nome.split("T")[0].split("-");
      const dataFormatada = `${partes[2]}-${partes[1]}-${partes[0]}`;
      localStorage.setItem("notaSelecionada", JSON.stringify({ data: dataFormatada, conteudo }));
      window.open("nota.html", "_blank");
    };
    tdAcao.appendChild(btnVer);

    tr.appendChild(tdCheckbox);
    tr.appendChild(tdIndex);
    tr.appendChild(tdData);
    tr.appendChild(tdAcao);

    tabela.appendChild(tr);
  });
}


function quebrarCamposNota(texto) {
  const campos = {
    data: "",
    fato: "",
    reacao: "",
    sentimento: "",
    proposta: ""
  };

  texto.split("\n").forEach(linha => {
    if (linha.startsWith("Data:")) campos.data = linha.replace("Data:", "").trim();
    if (linha.startsWith("Fato:")) campos.fato = linha.replace("Fato:", "").trim();
    if (linha.startsWith("Reação:")) campos.reacao = linha.replace("Reação:", "").trim();
    if (linha.startsWith("Sentimento:")) campos.sentimento = linha.replace("Sentimento:", "").trim();
    if (linha.startsWith("Proposta:")) campos.proposta = linha.replace("Proposta:", "").trim();
  });

  return campos;
}


async function obterNotasSelecionadas() {
  const selecionados = Array.from(document.querySelectorAll(".linha-selecao:checked"));
  const lista = [];
  for (const chk of selecionados) {
    const conteudo = await window.electronAPI.lerNota(chk.dataset.nome);
    lista.push({ nome: chk.dataset.nome, conteudo });
  }
  return lista;
}

dataInicioInput.addEventListener("change", () => {
  renderTabela(arquivos);
});

dataFimInput.addEventListener("change", () => {
  renderTabela(arquivos);
});

document.getElementById("btnVisualizarSelecionados").onclick = async () => {
  const selecionadas = await obterNotasSelecionadas();
  if (selecionadas.length === 0) {
    alert("Nenhuma nota selecionada.");
    return;
  }
  localStorage.setItem("notasSelecionadas", JSON.stringify(selecionadas));
  window.open("nota.html?multi=true", "_blank");
};

document.getElementById("btnExportarSelecionados").onclick = async () => {
  const selecionadas = await obterNotasSelecionadas();
  if (selecionadas.length === 0) {
    alert("Nenhuma nota selecionada.");
    return;
  }

  try {
    const usuario = await window.electronAPI.lerUsuario();

    let conteudos = `
  <div style="font-family: Arial, sans-serif; padding: 2rem 2rem 0.2rem 2rem; background:white; text-align:center;">
    <img src="https://geea.com.br/imagem/trevo.png" alt="Logo Trevo" style="max-width: 150px; margin-bottom: 1rem;" />
    <h1>ESCOLA DE APRENDIZES DO EVANGELHO</h1>
    <div style="text-align:left; margin-top: 0.2rem;">
      <p><strong>Casa Espírita:</strong> ${usuario.casaEspírita || ""}</p>
      <p><strong>Número da Turma:</strong> ${usuario.numeroTurma || ""}</p>
      <p><strong>Dirigente:</strong> ${usuario.dirigente || ""}</p>
      <p><strong>Secretários:</strong> ${usuario.secretarios || ""}</p>
      <p><strong>Aluno:</strong> ${usuario.aluno || ""}</p>
    </div>
  </div>  
`;

conteudos += selecionadas.map((nota, index) => {
  const campos = quebrarCamposNota(corrigirDataTexto(nota.conteudo));
  return `
    <div class="nota-cartao" style="border:1px solid #ccc; border-radius:8px; margin:0.5rem 0; padding:1.5rem; background:#f9f9f9; page-break-inside: avoid;">
      <div style="margin-bottom: 1rem;"><strong>Data:</strong> ${campos.data}</div>
      <div style="margin-bottom: 1rem;"><strong>Fato:</strong> ${campos.fato}</div>
      <div style="margin-bottom: 1rem;"><strong>Reação:</strong> ${campos.reacao}</div>
      <div style="margin-bottom: 1rem;"><strong>Sentimento:</strong> ${campos.sentimento}</div>
      <div><strong>Proposta:</strong> ${campos.proposta}</div>
    </div>
  `;
}).join("");

try {
  // Gerar a data e hora atual
  const agora = new Date();
  const ano = agora.getFullYear();
  const mes = String(agora.getMonth() + 1).padStart(2, '0');
  const dia = String(agora.getDate()).padStart(2, '0');
  const hora = String(agora.getHours()).padStart(2, '0');
  const minuto = String(agora.getMinutes()).padStart(2, '0');
  const segundo = String(agora.getSeconds()).padStart(2, '0');

  const dataHoraFormatada = `${ano}-${mes}-${dia}_${hora}_${minuto}_${segundo}`;
  const nomeAluno = (usuario.aluno || "Aluno").replace(/\s+/g, '_'); // substituir espaços por "_"
  const nomeArquivo = `${dataHoraFormatada}-${nomeAluno}.pdf`;

  // Gerar o PDF usando o nome novo
  await window.electronAPI.gerarPdfUnico(conteudos, nomeArquivo);
  alert("PDF gerado com sucesso!\nO arquivo foi salvo em Downloads/Anotações_EAE/");
} catch (error) {
  console.error("Erro ao exportar:", error);
  alert("Erro ao exportar notas.");
};
</script>
</body>
</html>